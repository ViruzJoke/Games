<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏° Zombie Survival Outpost</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for Inter font and general styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background for a more "den" feel */
            color: #e2e8f0; /* Light text color */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        .game-container {
            background-color: #2d3748; /* Slightly lighter dark background for container */
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 1200px; /* Wider for more content */
            width: 100%;
            border: 1px solid #4a5568;
        }
        .section-header {
            font-size: 1.75rem; /* 28px */
            font-weight: 700; /* Bold */
            color: #fbd38d; /* Gold-like color for headers */
            margin-bottom: 1rem;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 0.5rem;
        }
        .panel {
            background-color: #4a5568; /* Darker panel background */
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #6b7280;
        }
        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background-color: #2d3748;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid #4a5568;
        }
        .list-item:hover {
            background-color: #4a5568;
            transform: translateY(-1px);
        }
        .list-item.selected {
            border: 3px solid #fbd38d; /* Gold highlight for selected item */
            background-color: #5b677a; /* Darker on select */
            transform: translateY(-2px);
        }
        .list-item-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #2d3748;
        }
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* Pill shape */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-image: linear-gradient(to right, var(--tw-gradient-stops)); /* Gradient background */
        }
        .button:hover:not(:disabled) {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            background-image: none; /* Disable gradient for disabled state */
            background-color: #6b7280; /* Gray-500 */
        }
        .button-primary {
            --tw-gradient-from: #f6ad55; /* Orange-400 */
            --tw-gradient-to: #ed8936; /* Orange-500 */
            color: #2d3748; /* Dark text for contrast */
        }
        .button-success {
            --tw-gradient-from: #68d391; /* Green-400 */
            --tw-gradient-to: #48bb78; /* Green-500 */
            color: #2d3748;
        }
        .button-danger {
            --tw-gradient-from: #fc8181; /* Red-400 */
            --tw-gradient-to: #e53e3e; /* Red-500 */
            color: white;
        }
        .button-secondary {
            --tw-gradient-from: #a0aec0; /* Gray-400 */
            --tw-gradient-to: #718096; /* Gray-500 */
            color: white;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2d3748;
            border: 2px solid #fbd38d;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            text-align: center;
            max-width: 400px;
            width: 90%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .message-box.visible {
            opacity: 1;
            visibility: visible;
        }
        .message-box .actions {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            margin-top: 1.5rem;
        }


        /* Equipped item specific styling */
        .equipped-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #6b7280;
        }
        .equipped-slot:last-child {
            border-bottom: none;
        }
        .equipped-slot-name {
            font-weight: 500;
            color: #cbd5e0;
            flex-grow: 1;
        }
        .equipped-item-name {
            color: #fbd38d;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        .unequip-button {
            background-color: #e53e3e; /* Red-600 */
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .unequip-button:hover {
            background-color: #c53030; /* Red-700 */
        }
        .facility-assigned-survivors {
            margin-top: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            color: #a0aec0; /* gray-400 */
        }
        .facility-assigned-survivors span {
            display: inline-block;
            background-color: #5b677a; /* Darker gray */
            border-radius: 0.5rem;
            padding: 0.2rem 0.5rem;
            margin-right: 0.5rem;
            margin-bottom: 0.2rem;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .game-container {
                padding: 1rem;
            }
            .grid {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
            .button {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
        }
        @media (min-width: 769px) {
            .grid {
                grid-template-columns: 1fr 1fr; /* Two columns for larger screens */
            }
        }
        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: 1fr 1fr 1fr; /* Three columns for very large screens */
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="text-4xl font-extrabold text-center text-fbd38d mb-6">Zombie Survival Outpost</h1>

        <!-- Top Dashboard -->
        <div class="panel flex justify-between items-center mb-4">
            <div class="text-xl font-bold">‡∏ß‡∏±‡∏ô: <span id="current-day">1</span></div>
            <div class="flex items-center text-xl font-bold">
                <span class="mr-2 text-gray-400">&#x1F529;</span> ‡πÄ‡∏®‡∏©‡∏ß‡∏±‡∏™‡∏î‡∏∏: <span id="player-scrap">0</span>
                <span class="ml-4 mr-2 text-green-400">&#x1F355;</span> ‡∏≠‡∏≤‡∏´‡∏≤‡∏£: <span id="player-food">0</span>
                <span class="ml-4 mr-2 text-blue-400">&#x1F4A7;</span> ‡∏ô‡πâ‡∏≥: <span id="player-water">0</span>
                <span class="ml-4 mr-2 text-red-400">&#x1F48A;</span> ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå: <span id="player-med-supplies">0</span>
            </div>
            <div class="flex gap-2 ml-4">
                <button id="save-game-button" class="button button-secondary text-sm px-3 py-1">
                    <span class="mr-1">&#x1F4BE;</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button id="load-game-button" class="button button-secondary text-sm px-3 py-1">
                    <span class="mr-1">&#x1F4C2;</span> ‡πÇ‡∏´‡∏•‡∏î
                </button>
                <button id="next-day-button" class="button button-success text-sm px-3 py-1">
                    <span class="mr-1">&#x23ED;</span> ‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                </button>
            </div>
        </div>

        <!-- Shelter Button / Back to Outpost Button -->
        <div class="panel flex justify-center mt-2 mb-4">
            <button id="view-toggle-button" class="button button-primary w-full max-w-sm">
                <span class="mr-2">&#x1F3E0;</span> ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á
            </button>
        </div>

        <!-- Main Game View -->
        <div id="main-game-view">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- Left Column: Survivor Roster -->
                <div class="flex flex-col gap-6">
                    <div class="panel">
                        <h2 class="section-header">‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>
                        <div id="survivor-list" class="flex flex-col gap-2 max-h-80 overflow-y-auto">
                            <!-- Survivor items will be dynamically inserted here -->
                            <div class="text-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï...</div>
                        </div>
                    </div>
                </div>

                <!-- Center Column: Survivor Details (ONLY) -->
                <div class="panel">
                    <h2 class="section-header">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</h2>
                    <div id="details-panel">
                        <p class="text-gray-400 text-center mb-4">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                        <div id="selected-survivor-details" class="hidden">
                            <h3 class="text-2xl font-bold text-fbd38d mb-2" id="detail-survivor-name"></h3>
                            <p>‡πÄ‡∏•‡πÄ‡∏ß‡∏•: <span id="detail-survivor-level"></span></p>
                            <p>XP: <span id="detail-survivor-xp"></span> / <span id="detail-survivor-xp-needed"></span></p>
                            <p>‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï: <span id="detail-survivor-health"></span>/<span id="detail-survivor-max-health"></span> <span id="detail-survivor-injured-status" class="text-red-500 font-semibold ml-2"></span></p>
                            <p>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á: <span id="detail-survivor-strength"></span></p>
                            <p>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß: <span id="detail-survivor-agility"></span></p>

                            <h4 class="text-xl font-semibold text-fbd38d mt-6 mb-3">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà</h4>
                            <div id="equipped-items-display" class="flex flex-col gap-2">
                                <!-- Equipped items will be rendered here dynamically -->
                            </div>
                            <button id="heal-survivor-button" class="button button-danger w-full mt-4" disabled>
                                <span class="mr-2">&#x1F48A;</span> ‡∏£‡∏±‡∏Å‡∏©‡∏≤ (10<span class="text-red-400">&#x1F48A;</span>)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Scavenge Mission Board & Inventory -->
                <div class="flex flex-col gap-6">
                    <!-- Scavenge Mission Board -->
                    <div class="panel">
                        <h2 class="section-header">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏≤‡∏Ç‡∏≠‡∏á</h2>
                        <div id="scavenge-mission-list" class="flex flex-col gap-2 max-h-40 overflow-y-auto">
                            <!-- Mission items will be dynamically inserted here -->
                            <div class="text-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...</div>
                        </div>
                        <button id="send-scavenge-mission-button" class="button button-primary w-full mt-4" disabled>
                            <span class="mr-2">&#x1F4CD;</span> ‡∏™‡πà‡∏á‡∏ó‡∏µ‡∏°‡∏≠‡∏≠‡∏Å‡∏´‡∏≤‡∏Ç‡∏≠‡∏á
                        </button>
                    </div>

                    <!-- Inventory Panel -->
                    <div class="panel">
                        <h2 class="section-header">‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
                        <div id="inventory-list" class="flex flex-col gap-2 max-h-40 overflow-y-auto">
                            <!-- Inventory items will be dynamically inserted here -->
                            <div class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</div>
                        </div>
                        <button id="buy-item-button" class="button button-secondary w-full mt-4" disabled>
                            <span class="mr-2">&#x1F529;</span> ‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏£‡∏≤‡∏Ñ‡∏≤: <span id="item-buy-cost">0</span><span class="text-gray-400">&#x1F529;</span>)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shelter View -->
        <div id="shelter-view" class="hidden">
            <div class="panel mb-6">
                <h2 class="section-header">‡∏™‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á</h2>
                <div id="shelter-facilities-list" class="flex flex-col gap-4">
                    <!-- Facilities will be dynamically inserted here -->
                    <div class="text-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á...</div>
                </div>
            </div>
        </div>


        <!-- Game Message/Log -->
        <div class="panel mt-4">
            <h2 class="section-header">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
            <div id="game-log" class="bg-gray-800 p-4 rounded-lg text-sm h-40 overflow-y-auto text-gray-300">
                <!-- Game messages will appear here -->
                <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Zombie Survival Outpost!</p>
            </div>
        </div>

    </div>

    <!-- Message Box for Alerts -->
    <div id="message-box" class="message-box">
        <p id="message-box-text" class="text-lg mb-6"></p>
        <div class="actions">
            <button id="message-box-ok" class="button button-primary">‡∏ï‡∏Å‡∏•‡∏á</button>
            <button id="message-box-cancel" class="button button-secondary hidden">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const currentDayEl = document.getElementById('current-day');
        const playerScrapEl = document.getElementById('player-scrap');
        const playerFoodEl = document.getElementById('player-food');
        const playerWaterEl = document.getElementById('player-water');
        const playerMedSuppliesEl = document.getElementById('player-med-supplies');
        const nextDayButton = document.getElementById('next-day-button');
        const saveGameButton = document.getElementById('save-game-button');
        const loadGameButton = document.getElementById('load-game-button');
        const viewToggleButton = document.getElementById('view-toggle-button');
        const mainGameView = document.getElementById('main-game-view');
        const shelterView = document.getElementById('shelter-view');

        const survivorListEl = document.getElementById('survivor-list');
        const scavengeMissionListEl = document.getElementById('scavenge-mission-list');
        const sendScavengeMissionButton = document.getElementById('send-scavenge-mission-button');
        const detailsPanelEl = document.getElementById('details-panel');
        const selectedSurvivorDetailsEl = document.getElementById('selected-survivor-details');
        const detailSurvivorNameEl = document.getElementById('detail-survivor-name');
        const detailSurvivorLevelEl = document.getElementById('detail-survivor-level');
        const detailSurvivorXpEl = document.getElementById('detail-survivor-xp');
        const detailSurvivorXpNeededEl = document.getElementById('detail-survivor-xp-needed');
        const detailSurvivorHealthEl = document.getElementById('detail-survivor-health');
        const detailSurvivorMaxHealthEl = document.getElementById('detail-survivor-max-health');
        const detailSurvivorInjuredStatusEl = document.getElementById('detail-survivor-injured-status');
        const detailSurvivorStrengthEl = document.getElementById('detail-survivor-strength');
        const detailSurvivorAgilityEl = document.getElementById('detail-survivor-agility');
        const equippedItemsDisplayEl = document.getElementById('equipped-items-display');
        const healSurvivorButton = document.getElementById('heal-survivor-button');
        const inventoryListEl = document.getElementById('inventory-list');
        const buyItemButton = document.getElementById('buy-item-button');
        const itemBuyCostEl = document.getElementById('item-buy-cost');
        const gameLogEl = document.getElementById('game-log');
        const messageBox = document.getElementById('message-box');
        const messageBoxText = document.getElementById('message-box-text');
        const messageBoxOk = document.getElementById('message-box-ok');
        const messageBoxCancel = document.getElementById('message-box-cancel');
        const shelterFacilitiesListEl = document.getElementById('shelter-facilities-list');

        // --- Game Constants ---
        const BASE_SURVIVOR_HEALTH = 100;
        const BASE_INJURY_DURATION = 3;
        const MAJOR_INJURY_DURATION = 5;
        const HEAL_COST_MED_SUPPLIES = 10;
        const SURVIVOR_DISCOVERY_CHANCE = 0.10; // 10% chance

        const XP_TO_LEVEL = [0, 100, 250, 500, 800, 1200, 1800, 2500, 3500, 5000];

        // Define a template for initial game state to use for loading (for backward compatibility)
        const DEFAULT_GAME_STATE = {
            currentDay: 1,
            scrap: 500,
            food: 200,
            water: 200,
            medSupplies: 50,
            survivors: [
                { id: 'S0', name: 'Rick', level: 1, xp: 0, strength: 25, agility: 25, health: BASE_SURVIVOR_HEALTH, maxHealth: BASE_SURVIVOR_HEALTH, isInjured: false, injuryDuration: 0, isBusy: false, missionEndTime: 0, currentMissionId: null, assignedFacilityId: null, equipped: { helmet: null, chest: 'armor_reinforced_chest', arms: null, legs: null, mainHand: 'weapon_shotgun', offHand: null } },
                { id: 'S1', name: 'Michonne', level: 1, xp: 0, strength: 15, agility: 20, health: BASE_SURVIVOR_HEALTH, maxHealth: BASE_SURVIVOR_HEALTH, isInjured: false, injuryDuration: 0, isBusy: false, missionEndTime: 0, currentMissionId: null, assignedFacilityId: null, equipped: { helmet: null, chest: 'armor_makeshift_chest', arms: null, legs: null, mainHand: 'weapon_machete', offHand: null } },
                { id: 'S2', name: 'Daryl', level: 1, xp: 0, strength: 20, agility: 18, health: BASE_SURVIVOR_HEALTH, maxHealth: BASE_SURVIVOR_HEALTH, isInjured: false, injuryDuration: 0, isBusy: false, missionEndTime: 0, currentMissionId: null, assignedFacilityId: null, equipped: { helmet: null, chest: null, arms: null, legs: null, mainHand: 'weapon_assault_rifle', offHand: null } }
            ],
            scavengeMissions: [], // Will be regenerated anyway
            inventory: {
                'weapon_shotgun': 1,
                'armor_reinforced_chest': 1,
                'weapon_pipe_melee': 2,
                'armor_makeshift_chest': 1,
                'weapon_assault_rifle': 1,
                'armor_makeshift_helmet': 1,
                'armor_makeshift_arms': 1,
                'armor_makeshift_legs': 1,
                'weapon_machete': 1,
                'weapon_pistol': 1,
                'weapon_heavy_shield': 1,
            },
            selectedSurvivorId: null,
            selectedMissionId: null,
            selectedItemId: null,
            currentView: 'outpost',
            shelter: {
                workshop: { level: 0, maxLevel: 3, name: '‡πÇ‡∏£‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå', upgradeCostBase: 50, upgradeDurationBase: 1, upgradeResource: 'scrap', benefitDesc: '‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå 10% ‡∏ï‡πà‡∏≠ Lv.', benefit: 0.1, slots: 0, maxSlots: 3, assignedSurvivors: [], isUpgrading: false, upgradeEndTime: 0 },
                infirmary: { level: 0, maxLevel: 3, name: '‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', upgradeCostBase: 75, upgradeDurationBase: 1, upgradeResource: 'scrap', benefitDesc: '‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à 1 ‡∏ß‡∏±‡∏ô & ‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö 1 ‡∏ß‡∏±‡∏ô ‡∏ï‡πà‡∏≠ Lv.', benefit: 1, slots: 0, maxSlots: 3, assignedSurvivors: [], isUpgrading: false, upgradeEndTime: 0 },
                foodFarm: { level: 0, maxLevel: 3, name: '‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£', upgradeCostBase: 100, upgradeDurationBase: 2, upgradeResource: 'scrap', benefitDesc: '‡∏ú‡∏•‡∏¥‡∏ï‡∏≠‡∏≤‡∏´‡∏≤‡∏£ +10 ‡∏´‡∏ô‡πà‡∏ß‡∏¢/‡∏ß‡∏±‡∏ô ‡∏ï‡πà‡∏≠ Lv. (+5% ‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô)', production: { food: 10 }, slots: 0, maxSlots: 3, assignedSurvivors: [], isUpgrading: false, upgradeEndTime: 0 },
                waterPurifier: { level: 0, maxLevel: 3, name: '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥', upgradeCostBase: 100, upgradeDurationBase: 2, upgradeResource: 'scrap', benefitDesc: '‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡πâ‡∏≥ +10 ‡∏´‡∏ô‡πà‡∏ß‡∏¢/‡∏ß‡∏±‡∏ô ‡∏ï‡πà‡∏≠ Lv. (+5% ‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô)', production: { water: 10 }, slots: 0, maxSlots: 3, assignedSurvivors: [], isUpgrading: false, upgradeEndTime: 0 },
                medicalStorage: { level: 0, maxLevel: 3, name: '‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå', upgradeCostBase: 150, upgradeDurationBase: 3, upgradeResource: 'scrap', benefitDesc: '‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå +5 ‡∏´‡∏ô‡πà‡∏ß‡∏¢/‡∏ß‡∏±‡∏ô ‡∏ï‡πà‡∏≠ Lv. (+5% ‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô)', production: { medSupplies: 5 }, slots: 0, maxSlots: 3, assignedSurvivors: [], isUpgrading: false, upgradeEndTime: 0 },
                guardPost: { level: 0, maxLevel: 3, name: '‡∏õ‡πâ‡∏≠‡∏°‡∏¢‡∏≤‡∏°', upgradeCostBase: 120, upgradeDurationBase: 2, upgradeResource: 'scrap', benefitDesc: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à +2% ‡∏ï‡πà‡∏≠ Lv. (+1% ‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô)', bonusChance: 0.02, slots: 0, maxSlots: 3, assignedSurvivors: [], isUpgrading: false, upgradeEndTime: 0 },
                medicalLab: { level: 0, maxLevel: 3, name: '‡∏´‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå', upgradeCostBase: 180, upgradeDurationBase: 3, upgradeResource: 'scrap', benefitDesc: '‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå +7 ‡∏´‡∏ô‡πà‡∏ß‡∏¢/‡∏ß‡∏±‡∏ô ‡∏ï‡πà‡∏≠ Lv. (+5% ‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô)', production: { medSupplies: 7 }, slots: 0, maxSlots: 3, assignedSurvivors: [], isUpgrading: false, upgradeEndTime: 0 }
            }
        };

        // --- Game Data (will be initialized from DEFAULT_GAME_STATE) ---
        let gameData;

        const BASE_SCAVENGE_MISSIONS = [
            { id: 'M1', name: '‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡∏°‡∏≤‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ï‡∏£‡πâ‡∏≤‡∏á', difficulty: '‡∏á‡πà‡∏≤‡∏¢', xpReward: 50, scrapReward: 100, itemReward: 'weapon_pipe_melee', successChanceBase: 0.8, duration: 1 },
            { id: 'M2', name: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏Å‡πà‡∏≤', difficulty: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', xpReward: 100, scrapReward: 200, itemReward: 'armor_makeshift_chest', successChanceBase: 0.6, duration: 2 },
            { id: 'M3', name: '‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏¥‡πâ‡∏á‡∏£‡πâ‡∏≤‡∏á', difficulty: '‡∏¢‡∏≤‡∏Å', xpReward: 200, scrapReward: 400, itemReward: 'weapon_shotgun', successChanceBase: 0.4, duration: 3 },
            { id: 'M4', name: '‡∏•‡∏≤‡∏î‡∏ï‡∏£‡∏∞‡πÄ‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á', difficulty: '‡∏á‡πà‡∏≤‡∏¢', xpReward: 60, scrapReward: 120, itemReward: 'armor_makeshift_helmet', successChanceBase: 0.75, duration: 1 },
            { id: 'M5', name: '‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á‡πÄ‡∏Å‡πà‡∏≤', difficulty: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', xpReward: 120, scrapReward: 250, itemReward: 'armor_makeshift_arms', successChanceBase: 0.55, duration: 2 },
            { id: 'M6', name: '‡∏£‡∏±‡∏á‡∏ã‡∏≠‡∏°‡∏ö‡∏µ‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', difficulty: '‡∏¢‡∏≤‡∏Å', xpReward: 300, scrapReward: 600, itemReward: 'weapon_assault_rifle', successChanceBase: 0.35, duration: 4 },
            { id: 'M7', name: '‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏á', difficulty: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', xpReward: 150, scrapReward: 300, itemReward: 'armor_makeshift_legs', successChanceBase: 0.5, duration: 2 },
            { id: 'M8', name: '‡πÄ‡∏Ç‡∏ï‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢', difficulty: '‡∏¢‡∏≤‡∏Å', xpReward: 400, scrapReward: 800, itemReward: 'weapon_heavy_shield', successChanceBase: 0.3, duration: 5 },
        ];

        // Updated ALL_ITEMS with icons
        const ALL_ITEMS = {
            'weapon_pipe_melee': { id: 'weapon_pipe_melee', name: '‡∏ó‡πà‡∏≠‡∏ô‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏ó‡∏∏‡∏ö', type: 'weapon', slot: 'one_hand', bonus: { strength: 5, agility: 2 }, cost: 50, icon: '‚öîÔ∏è' },
            'armor_makeshift_chest': { id: 'armor_makeshift_chest', name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå', type: 'armor', slot: 'chest', bonus: { agility: 5 }, cost: 75, icon: 'üõ°Ô∏è' },
            'weapon_shotgun': { id: 'weapon_shotgun', name: '‡∏õ‡∏∑‡∏ô‡∏•‡∏π‡∏Å‡∏ã‡∏≠‡∏á', type: 'weapon', slot: 'two_hand', bonus: { strength: 20, agility: 5 }, cost: 500, icon: 'üî´' },
            'armor_reinforced_chest': { id: 'armor_reinforced_chest', name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏´‡∏•‡πá‡∏Å', type: 'armor', slot: 'chest', bonus: { strength: 10 }, cost: 200, icon: 'üõ°Ô∏è' },
            'weapon_assault_rifle': { id: 'weapon_assault_rifle', name: '‡∏õ‡∏∑‡∏ô‡πÑ‡∏£‡πÄ‡∏ü‡∏¥‡∏•‡∏à‡∏π‡πà‡πÇ‡∏à‡∏°', type: 'weapon', slot: 'ranged', bonus: { agility: 8 }, cost: 120, icon: 'üî´' },
            'medical_kit': { id: 'medical_kit', name: '‡∏ä‡∏∏‡∏î‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', type: 'consumable', slot: 'none', cost: 30, icon: 'üíä' },
            'armor_makeshift_helmet': { id: 'armor_makeshift_helmet', name: '‡∏´‡∏°‡∏ß‡∏Å‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå', type: 'armor', slot: 'helmet', bonus: { strength: 2, agility: 1 }, cost: 60, icon: 'ü™ñ' },
            'armor_makeshift_arms': { id: 'armor_makeshift_arms', name: '‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡πÅ‡∏Ç‡∏ô‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå', type: 'armor', slot: 'arms', bonus: { strength: 3, agility: 0 }, cost: 40, icon: 'üß§' },
            'armor_makeshift_legs': { id: 'armor_makeshift_legs', name: '‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏Ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå', type: 'armor', slot: 'legs', bonus: { strength: 3, agility: 1 }, cost: 50, icon: 'üëñ' },
            'weapon_machete': { id: 'weapon_machete', name: '‡∏°‡∏µ‡∏î‡∏°‡∏≤‡πÄ‡∏ä‡πÄ‡∏ï‡πâ', type: 'weapon', slot: 'one_hand', bonus: { strength: 8, agility: 3 }, cost: 80, icon: 'üî™' },
            'weapon_pistol': { id: 'weapon_pistol', name: '‡∏õ‡∏∑‡∏ô‡∏û‡∏Å', type: 'weapon', slot: 'one_hand', bonus: { agility: 6 }, cost: 70, icon: 'üî´' },
            'weapon_heavy_shield': { id: 'weapon_heavy_shield', name: '‡πÇ‡∏•‡πà‡∏´‡∏ô‡∏±‡∏Å', type: 'armor', slot: 'shield', bonus: { strength: 15 }, cost: 150, icon: 'üõ°Ô∏è' },
            'armor_military_helmet': { id: 'armor_military_helmet', name: '‡∏´‡∏°‡∏ß‡∏Å‡∏ó‡∏´‡∏≤‡∏£', type: 'armor', slot: 'helmet', bonus: { strength: 5, agility: 2 }, cost: 150, icon: 'ü™ñ' },
            'armor_military_chest': { id: 'armor_military_chest', name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏ó‡∏´‡∏≤‡∏£', type: 'armor', slot: 'chest', bonus: { strength: 15, agility: 5 }, cost: 300, icon: 'üõ°Ô∏è' },
        };


        // --- Utility Functions ---
        function addLog(message) {
            const p = document.createElement('p');
            p.textContent = `[‡∏ß‡∏±‡∏ô ${gameData.currentDay}] ${message}`;
            gameLogEl.prepend(p);
            if (gameLogEl.children.length > 50) {
                gameLogEl.removeChild(gameLogEl.lastChild);
            }
            gameLogEl.scrollTop = 0;
        }

        let messageBoxTimeout;
        let messageBoxResolve; // To handle promises for message box
        function showMessageBox(message, type = 'ok', buttons = ['ok']) {
            messageBoxText.textContent = message;
            messageBoxOk.classList.remove('hidden');
            messageBoxCancel.classList.add('hidden'); // Hide cancel by default

            if (type === 'confirm') {
                messageBoxOk.textContent = buttons[0] || '‡∏ï‡∏Å‡∏•‡∏á';
                messageBoxCancel.textContent = buttons[1] || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                messageBoxCancel.classList.remove('hidden');
                messageBox.classList.add('visible'); // Show immediately for confirm
                clearTimeout(messageBoxTimeout); // No auto-hide for confirm
                return new Promise(resolve => {
                    messageBoxResolve = resolve;
                });
            } else {
                messageBoxOk.textContent = buttons[0] || '‡∏ï‡∏Å‡∏•‡∏á';
                messageBox.classList.add('visible');
                clearTimeout(messageBoxTimeout);
                messageBoxTimeout = setTimeout(() => hideMessageBox(), 3000); // Auto-hide after 3 seconds
            }
        }

        function hideMessageBox(result = true) {
            messageBox.classList.remove('visible');
            if (messageBoxResolve) {
                messageBoxResolve(result);
                messageBoxResolve = null; // Clear resolve function
            }
        }

        // Function to toggle between Outpost and Shelter views
        function toggleView() {
            if (gameData.currentView === 'outpost') {
                gameData.currentView = 'shelter';
                mainGameView.classList.add('hidden');
                shelterView.classList.remove('hidden');
                viewToggleButton.innerHTML = '<span class="mr-2">&#x1F3D8;</span> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Outpost';
                renderShelterFacilities(); // Re-render facilities when opening
            } else {
                gameData.currentView = 'outpost';
                mainGameView.classList.remove('hidden');
                shelterView.classList.add('hidden');
                viewToggleButton.innerHTML = '<span class="mr-2">&#x1F3E0;</span> ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á';
            }
            updateUI(); // To update button states
        }

        // --- Game Logic ---
        function initializeGame() {
            // Deep copy the default game state to initialize
            gameData = JSON.parse(JSON.stringify(DEFAULT_GAME_STATE)); 
            gameData.selectedSurvivorId = null;
            gameData.selectedMissionId = null;
            gameData.selectedItemId = null;
            gameData.currentView = 'outpost';

            generateNewScavengeMissions(); // This will populate gameData.scavengeMissions
            updateUI();
            addLog("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Zombie Survival Outpost! ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏î!");
        }

        // Save game state to Local Storage
        function saveGame() {
            try {
                localStorage.setItem('zombieSurvivalSave', JSON.stringify(gameData));
                addLog("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                showMessageBox("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch (e) {
                console.error("Error saving game:", e);
                showMessageBox("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            }
        }

        // Load game state from Local Storage
        function loadGame() {
            try {
                const savedData = localStorage.getItem('zombieSurvivalSave');
                if (savedData) {
                    const loadedGameData = JSON.parse(savedData);

                    // Create a deep copy of the current default gameData structure
                    // This ensures any new properties or facilities added to the game
                    // are present even if loading an old save.
                    const defaultGameDataCopy = JSON.parse(JSON.stringify(DEFAULT_GAME_STATE)); 
                    
                    // Merge loaded data onto the default structure
                    // This prioritizes loaded values but ensures new fields exist.
                    gameData.currentDay = loadedGameData.currentDay !== undefined ? loadedGameData.currentDay : defaultGameDataCopy.currentDay;
                    gameData.scrap = loadedGameData.scrap !== undefined ? loadedGameData.scrap : defaultGameDataCopy.scrap;
                    gameData.food = loadedGameData.food !== undefined ? loadedGameData.food : defaultGameDataCopy.food;
                    gameData.water = loadedGameData.water !== undefined ? loadedGameData.water : defaultGameDataCopy.water;
                    gameData.medSupplies = loadedGameData.medSupplies !== undefined ? loadedGameData.medSupplies : defaultGameDataCopy.medSupplies;

                    // Merge survivors carefully to maintain structure
                    gameData.survivors = loadedGameData.survivors.map(loadedSurvivor => {
                        // Use a basic survivor template to ensure all properties exist
                        const defaultSurvivorTemplate = {
                            id: '', name: '', level: 1, xp: 0, strength: 10, agility: 10,
                            health: BASE_SURVIVOR_HEALTH, maxHealth: BASE_SURVIVOR_HEALTH,
                            isInjured: false, injuryDuration: 0, isBusy: false, missionEndTime: 0,
                            currentMissionId: null, assignedFacilityId: null,
                            equipped: { helmet: null, chest: null, arms: null, legs: null, mainHand: null, offHand: null }
                        };
                        // Merge loaded properties onto the template, ensuring nested 'equipped' is merged
                        return { 
                            ...defaultSurvivorTemplate, 
                            ...loadedSurvivor,
                            equipped: { ...defaultSurvivorTemplate.equipped, ...(loadedSurvivor.equipped || {}) } // Deep merge for equipped
                        };
                    });

                    // Merge inventory (simply overwrite with loaded if exists, else use default)
                    gameData.inventory = loadedGameData.inventory ? { ...loadedGameData.inventory } : { ...defaultGameDataCopy.inventory };

                    // Merge shelter facilities
                    for (const facilityId in defaultGameDataCopy.shelter) { // Iterate over expected facilities from default template
                        if (loadedGameData.shelter && loadedGameData.shelter[facilityId]) {
                            // Merge loaded facility properties onto the default template for that facility
                            gameData.shelter[facilityId] = { 
                                ...defaultGameDataCopy.shelter[facilityId], 
                                ...loadedGameData.shelter[facilityId] 
                            };
                        } else {
                            // If facility didn't exist in saved data, use the default template for that facility
                            gameData.shelter[facilityId] = { ...defaultGameDataCopy.shelter[facilityId] };
                        }
                        // Ensure slots are correctly calculated from level for backward compatibility
                        gameData.shelter[facilityId].slots = gameData.shelter[facilityId].level;
                        if (gameData.shelter[facilityId].level === 0) gameData.shelter[facilityId].slots = 0;
                        
                        // Ensure assignedSurvivors array is not null/undefined for older saves
                        if (!gameData.shelter[facilityId].assignedSurvivors) gameData.shelter[facilityId].assignedSurvivors = [];

                        // Ensure upgrade status properties exist
                        if (gameData.shelter[facilityId].isUpgrading === undefined) gameData.shelter[facilityId].isUpgrading = false;
                        if (gameData.shelter[facilityId].upgradeEndTime === undefined) gameData.shelter[facilityId].upgradeEndTime = 0;
                    }

                    // Scavenge Missions will be regenerated, no need to load old ones.
                    gameData.scavengeMissions = []; // Ensure old missions are cleared for regeneration

                    gameData.selectedSurvivorId = null;
                    gameData.selectedMissionId = null;
                    gameData.selectedItemId = null;
                    gameData.currentView = loadedGameData.currentView || 'outpost'; // Load view state

                    updateUI();
                    // Ensure correct view is displayed after loading
                    if (gameData.currentView === 'outpost') {
                        showMainGameView();
                    } else {
                        showShelterView();
                    }
                    addLog("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    showMessageBox("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                } else {
                    showMessageBox("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!");
                    addLog("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!");
                }
            } catch (e) {
                console.error("Error loading game:", e);
                showMessageBox("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢)");
            }
        }


        function generateNewScavengeMissions() {
            const missionPool = [...BASE_SCAVENGE_MISSIONS];
            gameData.scavengeMissions = [];
            for (let i = 0; i < 4; i++) {
                if (missionPool.length === 0) break;
                const randomIndex = Math.floor(Math.random() * missionPool.length);
                gameData.scavengeMissions.push(missionPool.splice(randomIndex, 1)[0]);
            }
            addLog("‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!");
        }

        function calculateSurvivorStats(survivor) {
            let totalStrength = survivor.strength;
            let totalAgility = survivor.agility;

            for (const slot in survivor.equipped) {
                const itemId = survivor.equipped[slot];
                if (itemId && ALL_ITEMS[itemId]) {
                    const item = ALL_ITEMS[itemId];
                    totalStrength += item.bonus.strength || 0;
                    totalAgility += item.bonus.agility || 0;
                }
            }
            return { strength: totalStrength, agility: totalAgility };
        }

        function getEffectiveMissionDuration(baseDuration) {
            const infirmary = gameData.shelter.infirmary;
            let reduction = 0;
            if (infirmary.level > 0 && !infirmary.isUpgrading) { // Only apply benefit if built and not upgrading
                reduction += (infirmary.level * infirmary.benefit); // Base reduction from infirmary level
                if (infirmary.assignedSurvivors.length > 0) {
                    // Each assigned survivor adds 0.1 day reduction
                    reduction += infirmary.assignedSurvivors.length * 0.1;
                }
            }
            return Math.max(1, baseDuration - reduction);
        }

        function getEffectiveInjuryDuration(baseDuration) {
            const infirmary = gameData.shelter.infirmary;
            let reduction = 0;
            if (infirmary.level > 0 && !infirmary.isUpgrading) { // Only apply benefit if built and not upgrading
                reduction += (infirmary.level * infirmary.benefit);
                // Each assigned survivor adds 0.5 day reduction
                if (infirmary.assignedSurvivors.length > 0) {
                    reduction += infirmary.assignedSurvivors.length * 0.5;
                }
            }
            return Math.max(1, baseDuration - reduction);
        }
        
        // Calculate effective bonus chance for missions from Guard Post
        function getEffectiveMissionSuccessBonus() {
            const guardPost = gameData.shelter.guardPost;
            let bonus = 0;
            if (guardPost.level > 0 && !guardPost.isUpgrading) { // Only apply benefit if built and not upgrading
                bonus += guardPost.level * guardPost.bonusChance; // Base bonus from level
                // Each assigned survivor adds 1% bonus
                if (guardPost.assignedSurvivors.length > 0) {
                    bonus += guardPost.assignedSurvivors.length * 0.01;
                }
            }
            return bonus;
        }

        function sendSurvivorOnScavengeMission() {
            const survivor = gameData.survivors.find(a => a.id === gameData.selectedSurvivorId);
            const mission = gameData.scavengeMissions.find(m => m.id === gameData.selectedMissionId);

            if (!survivor || !mission) {
                showMessageBox("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡πà‡∏≠‡∏ô!");
                return;
            }
            if (survivor.isBusy) {
                showMessageBox(`${survivor.name} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏¢‡∏π‡πà!`);
                return;
            }
            if (survivor.isInjured) {
                showMessageBox(`${survivor.name} ‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÑ‡∏õ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏î‡πâ`);
                return;
            }
            if (survivor.assignedFacilityId) { // Check if assigned to a facility
                showMessageBox(`${survivor.name} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô ${gameData.shelter[survivor.assignedFacilityId].name}! ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡πà‡∏≠‡∏ô`);
                return;
            }


            const effectiveStats = calculateSurvivorStats(survivor);
            let successChance = mission.successChanceBase;

            successChance += (survivor.level * 0.01);
            successChance += (effectiveStats.strength * 0.001);
            successChance += (effectiveStats.agility * 0.001);
            successChance += getEffectiveMissionSuccessBonus(); // Add global bonus from Guard Post

            successChance = Math.min(0.95, Math.max(0.05, successChance));

            addLog(`${survivor.name} ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à "${mission.name}"`);

            survivor.isBusy = true;
            survivor.currentMissionId = mission.id;
            survivor.missionEndTime = gameData.currentDay + getEffectiveMissionDuration(mission.duration);

            gameData.selectedSurvivorId = null;
            gameData.selectedMissionId = null;

            updateUI();
            showMessageBox(`‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ${survivor.name} ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à "${mission.name}" ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ô ${getEffectiveMissionDuration(mission.duration)} ‡∏ß‡∏±‡∏ô!`);
        }

        async function processMissionResults(survivor) {
            const mission = BASE_SCAVENGE_MISSIONS.find(m => m.id === survivor.currentMissionId);
            if (!mission) {
                addLog(`${survivor.name} ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô`);
                survivor.isBusy = false;
                survivor.missionEndTime = 0;
                survivor.currentMissionId = null;
                return;
            }

            const successRoll = Math.random();
            const effectiveStats = calculateSurvivorStats(survivor);
            let successChance = mission.successChanceBase;
            successChance += (survivor.level * 0.01);
            successChance += (effectiveStats.strength * 0.001);
            successChance += (effectiveStats.agility * 0.001);
            successChance += getEffectiveMissionSuccessBonus(); // Add global bonus from Guard Post
            successChance = Math.min(0.95, Math.max(0.05, successChance));

            const outcomeRoll = Math.random();

            let resultMessage = '';

            if (successRoll < successChance) {
                // Mission Success
                if (outcomeRoll < 0.8) { // 80% chance for normal success
                    resultMessage = `${survivor.name} ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à "${mission.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
                    survivor.xp += mission.xpReward;
                    gameData.scrap += mission.scrapReward;
                    addLog(resultMessage);
                    addLog(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${mission.scrapReward} ‡πÄ‡∏®‡∏©‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡πÅ‡∏•‡∏∞ ${mission.xpReward} XP`);
                    if (mission.itemReward) {
                        gameData.inventory[mission.itemReward] = (gameData.inventory[mission.itemReward] || 0) + 1;
                        addLog(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${ALL_ITEMS[mission.itemReward].name}`);
                    }
                    // Chance to find a new survivor
                    if (Math.random() < SURVIVOR_DISCOVERY_CHANCE) {
                         await confirmNewSurvivorDiscovery(); // Use await for confirmation
                    }
                } else { // 20% chance for injured success
                    resultMessage = `${survivor.name} ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à "${mission.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢!`;
                    survivor.xp += mission.xpReward;
                    gameData.scrap += mission.scrapReward;
                    survivor.isInjured = true;
                    survivor.injuryDuration = getEffectiveInjuryDuration(BASE_INJURY_DURATION);
                    survivor.health = Math.max(0, survivor.health - (Math.floor(Math.random() * 20) + 10));
                    addLog(resultMessage);
                    addLog(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${mission.scrapReward} ‡πÄ‡∏®‡∏©‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‡πÅ‡∏•‡∏∞ ${mission.xpReward} XP`);
                    if (mission.itemReward) {
                        gameData.inventory[mission.itemReward] = (gameData.inventory[mission.itemReward] || 0) + 1;
                        addLog(`‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${ALL_ITEMS[mission.itemReward].name}`);
                    }
                     if (Math.random() < SURVIVOR_DISCOVERY_CHANCE / 2) {
                         await confirmNewSurvivorDiscovery();
                     }
                }
                checkLevelUp(survivor);
            } else {
                // Mission Failure
                if (outcomeRoll < 0.9) { // 90% chance for minor/injured failure
                    resultMessage = `${survivor.name} ‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à "${mission.name}" ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! `;
                    survivor.xp += Math.floor(mission.xpReward * 0.1); // 10% XP on failure
                    if (outcomeRoll < 0.6) { // 60% chance for no gain
                        resultMessage += `‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤`;
                        addLog(resultMessage);
                    } else { // 30% chance for injured failure
                        resultMessage += `‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏´‡∏ô‡∏±‡∏Å!`;
                        survivor.isInjured = true;
                        survivor.injuryDuration = getEffectiveInjuryDuration(MAJOR_INJURY_DURATION);
                        survivor.health = Math.max(0, survivor.health - (Math.floor(Math.random() * 30) + 20));
                        addLog(resultMessage);
                    }
                } else { // 10% chance for death
                    resultMessage = `${survivor.name} ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à "${mission.name}"!`;
                    addLog(resultMessage);
                    showMessageBox(`${survivor.name} ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à "${mission.name}"!`);
                    gameData.survivors = gameData.survivors.filter(s => s.id !== survivor.id);
                    gameData.selectedSurvivorId = null;
                    updateUI();
                    return;
                }
            }

            survivor.isBusy = false;
            survivor.missionEndTime = 0;
            survivor.currentMissionId = null;
            updateUI();
        }

        async function confirmNewSurvivorDiscovery() {
            const newId = 'S' + (gameData.survivors.length + 1);
            const survivorNames = ['Ethan', 'Olivia', 'Noah', 'Sophia', 'Liam', 'Emma', 'Aiden', 'Mia', 'Jackson', 'Ava'];
            const randomName = survivorNames[Math.floor(Math.random() * survivorNames.length)];

            const newSurvivor = {
                id: newId,
                name: `${randomName}`,
                level: 1,
                xp: 0,
                strength: 10 + Math.floor(Math.random() * 5),
                agility: 10 + Math.random() * 5,
                health: BASE_SURVIVOR_HEALTH,
                maxHealth: BASE_SURVIVOR_HEALTH,
                isInjured: false,
                injuryDuration: 0,
                isBusy: false,
                missionEndTime: 0,
                currentMissionId: null,
                assignedFacilityId: null, // New property
                equipped: { helmet: null, chest: null, arms: null, legs: null, mainHand: null, offHand: null }
            };

            const accept = await showMessageBox(`‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà: ${newSurvivor.name}! ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, 'confirm', ['‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°', '‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö']);
            if (accept) {
                gameData.survivors.push(newSurvivor);
                addLog(`‡∏û‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà: ${newSurvivor.name} ‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á‡πÅ‡∏•‡πâ‡∏ß!`);
                showMessageBox(`‡∏£‡∏±‡∏ö ${newSurvivor.name} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß!`);
            } else {
                addLog(`‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${newSurvivor.name} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°`);
                showMessageBox(`‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö ${newSurvivor.name} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°`);
            }
            updateUI();
        }


        function checkLevelUp(survivor) {
            const nextLevelXpNeeded = XP_TO_LEVEL[survivor.level];
            if (nextLevelXpNeeded && survivor.xp >= nextLevelXpNeeded) {
                survivor.level++;
                survivor.strength += 2;
                survivor.agility += 2;
                survivor.maxHealth += 5;
                survivor.health = survivor.maxHealth;
                survivor.xp -= nextLevelXpNeeded;
                addLog(`${survivor.name} ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏û‡πÄ‡∏õ‡πá‡∏ô ${survivor.level} ‡πÅ‡∏•‡πâ‡∏ß!`);
                checkLevelUp(survivor);
            }
        }

        function healSurvivor(survivorId) {
            const survivor = gameData.survivors.find(s => s.id === survivorId);
            if (!survivor) return;

            if (!survivor.isInjured && survivor.health === survivor.maxHealth) {
                showMessageBox(`${survivor.name} ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà!`);
                return;
            }
            if (gameData.medSupplies < HEAL_COST_MED_SUPPLIES) {
                showMessageBox(`‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ${HEAL_COST_MED_SUPPLIES} ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå`);
                return;
            }

            gameData.medSupplies -= HEAL_COST_MED_SUPPLIES;
            survivor.health = survivor.maxHealth;
            survivor.isInjured = false;
            survivor.injuryDuration = 0;
            addLog(`${survivor.name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏à‡∏ô‡∏´‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß!`);
            updateUI();
        }

        // New function to unequip an item
        function unequipItem(survivorId, slot) {
            const survivor = gameData.survivors.find(s => s.id === survivorId);
            if (!survivor) return;

            const equippedItemId = survivor.equipped[slot];
            if (!equippedItemId) {
                showMessageBox(`‡∏ä‡πà‡∏≠‡∏á ${slot} ‡∏Ç‡∏≠‡∏á ${survivor.name} ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏≠‡∏¢‡∏π‡πà!`);
                return;
            }

            gameData.inventory[equippedItemId] = (gameData.inventory[equippedItemId] || 0) + 1; // Return to inventory
            survivor.equipped[slot] = null; // Clear slot

            addLog(`${survivor.name} ‡∏ñ‡∏≠‡∏î ${ALL_ITEMS[equippedItemId].name} ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß`);
            updateUI();
        }

        function equipItem(survivorId, itemId) {
            const survivor = gameData.survivors.find(s => s.id === survivorId);
            const item = ALL_ITEMS[itemId];

            if (!survivor || !item || gameData.inventory[itemId] === 0 || item.type === 'consumable') {
                showMessageBox("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏¥‡πâ‡∏á!");
                return;
            }

            // Determine target slot
            let targetSlot;
            if (item.slot === 'one_hand' || item.slot === 'two_hand' || item.slot === 'ranged' || item.slot === 'shield') {
                // Handle complex weapon slot logic
                if (item.slot === 'two_hand' || item.slot === 'ranged') {
                    // If current main hand is two-handed/ranged, unequip it
                    if (survivor.equipped.mainHand && (ALL_ITEMS[survivor.equipped.mainHand].slot === 'two_hand' || ALL_ITEMS[survivor.equipped.mainHand].slot === 'ranged')) {
                        unequipItem(survivor.id, 'mainHand');
                    }
                    // If current off hand has anything, unequip it
                    if (survivor.equipped.offHand) {
                        unequipItem(survivor.id, 'offHand');
                    }
                    targetSlot = 'mainHand';
                } else if (item.slot === 'one_hand' || item.slot === 'shield') {
                    // If main hand is free, put it there
                    if (!survivor.equipped.mainHand) {
                        targetSlot = 'mainHand';
                    }
                    // If main hand has one-hand weapon and off-hand is free, put it in off-hand
                    else if (survivor.equipped.mainHand && ALL_ITEMS[survivor.equipped.mainHand].slot === 'one_hand' && !survivor.equipped.offHand) {
                        targetSlot = 'offHand';
                    }
                    // If main hand has two-hand/ranged weapon, unequip it and put this in main hand
                    else if (survivor.equipped.mainHand && (ALL_ITEMS[survivor.equipped.mainHand].slot === 'two_hand' || ALL_ITEMS[survivor.equipped.mainHand].slot === 'ranged')) {
                        unequipItem(survivor.id, 'mainHand');
                        targetSlot = 'mainHand';
                    }
                    // If both hands are occupied by one-hand weapons, try to replace off-hand
                    else if (survivor.equipped.mainHand && survivor.equipped.offHand && ALL_ITEMS[survivor.equipped.mainHand].slot === 'one_hand' && (ALL_ITEMS[survivor.equipped.offHand].slot === 'one_hand' || ALL_ITEMS[survivor.equipped.offHand].slot === 'shield')) {
                        showMessageBox("‡∏ä‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà.");
                        unequipItem(survivor.id, 'offHand');
                        targetSlot = 'offHand';
                    } else {
                        showMessageBox("‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏ñ‡∏≠‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô");
                        return;
                    }
                }
            } else { // Armor slots
                targetSlot = item.slot;
                if (survivor.equipped[targetSlot]) {
                    unequipItem(survivor.id, targetSlot); // Unequip old item
                }
            }

            // Perform the equip
            if (targetSlot) {
                survivor.equipped[targetSlot] = itemId;
                gameData.inventory[itemId]--; // Decrease from inventory
                addLog(`${survivor.name} ‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà ${item.name} ‡πÅ‡∏•‡πâ‡∏ß`);
                gameData.selectedItemId = null;
                updateUI();
            }
        }


        function getBuyCost(itemId) {
            const item = ALL_ITEMS[itemId];
            if (!item) return { scrap: Infinity, food: 0, water: 0, medSupplies: 0 };

            let cost = { scrap: item.cost || 0, food: 0, water: 0, medSupplies: 0 };

            const workshop = gameData.shelter.workshop;
            let discount = 0;
            if (workshop.level > 0 && !workshop.isUpgrading) {
                discount = (workshop.level * workshop.benefit);
            }
            // Add bonus from assigned survivors in workshop
            if (workshop.assignedSurvivors.length > 0) {
                 discount += workshop.assignedSurvivors.length * 0.01; // E.g., 1% additional discount per assigned survivor
            }

            cost.scrap = Math.max(0, Math.round(cost.scrap * (1 - discount)));

            return cost;
        }

        function buyItem() {
            const item = ALL_ITEMS[gameData.selectedItemId];
            if (!item) {
                showMessageBox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô!");
                return;
            }
            const cost = getBuyCost(item.id);

            // Check if all resources are sufficient
            const hasEnoughResources = gameData.scrap >= cost.scrap &&
                                       gameData.food >= cost.food &&
                                       gameData.water >= cost.water &&
                                       gameData.medSupplies >= cost.medSupplies;

            if (hasEnoughResources) {
                gameData.scrap -= cost.scrap;
                gameData.food -= cost.food;
                gameData.water -= cost.water;
                gameData.medSupplies -= cost.medSupplies;

                gameData.inventory[item.id] = (gameData.inventory[item.id] || 0) + 1;
                addLog(`‡∏ã‡∏∑‡πâ‡∏≠ ${item.name} ‡∏°‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ ${cost.scrap} ‡πÄ‡∏®‡∏©‡∏ß‡∏±‡∏™‡∏î‡∏∏`);
                gameData.selectedItemId = null;
                updateUI();
            } else {
                let missingResources = [];
                if (gameData.scrap < cost.scrap) missingResources.push(`${cost.scrap - gameData.scrap} ‡πÄ‡∏®‡∏©‡∏ß‡∏±‡∏™‡∏î‡∏∏`);
                if (cost.food > 0 && gameData.food < cost.food) missingResources.push(`${cost.food - gameData.food} ‡∏≠‡∏≤‡∏´‡∏≤‡∏£`);
                if (cost.water > 0 && gameData.water < cost.water) missingResources.push(`${cost.water - gameData.water} ‡∏ô‡πâ‡∏≥`);
                if (cost.medSupplies > 0 && gameData.medSupplies < cost.medSupplies) missingResources.push(`${cost.medSupplies - gameData.medSupplies} ‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå`);

                showMessageBox(`‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏ã‡∏∑‡πâ‡∏≠ ${item.name}! ‡∏Ç‡∏≤‡∏î: ${missingResources.join(', ')}`);
            }
        }

        function getUpgradeCost(facilityId) {
            const facility = gameData.shelter[facilityId];
            if (!facility || facility.level >= facility.maxLevel) return { scrap: Infinity };

            let cost = {};
            cost[facility.upgradeResource] = facility.upgradeCostBase * (facility.level + 1); // Cost based on next level

            return cost;
        }

        function getUpgradeDuration(facilityId) {
            const facility = gameData.shelter[facilityId];
            if (!facility) return Infinity;
            return facility.upgradeDurationBase * (facility.level + 1); // Duration increases with level
        }

        function upgradeFacility(facilityId) {
            const facility = gameData.shelter[facilityId];
            const cost = getUpgradeCost(facilityId);
            const resourceType = Object.keys(cost)[0];
            const duration = getUpgradeDuration(facilityId);

            if (!facility) {
                showMessageBox("‡∏™‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
                return;
            }

            if (facility.level >= facility.maxLevel) {
                showMessageBox(`${facility.name} ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß!`);
                return;
            }
            if (facility.isUpgrading) {
                showMessageBox(`${facility.name} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏≠‡∏¢‡∏π‡πà!`);
                return;
            }

            if (gameData[resourceType] >= cost[resourceType]) {
                gameData[resourceType] -= cost[resourceType];
                facility.isUpgrading = true;
                facility.upgradeEndTime = gameData.currentDay + duration;
                addLog(`${facility.name} ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡πÄ‡∏ß‡∏• ${facility.level + 1} ‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô ${duration} ‡∏ß‡∏±‡∏ô!`);
                updateUI();
            } else {
                let missingResourceName = resourceType === 'scrap' ? '‡πÄ‡∏®‡∏©‡∏ß‡∏±‡∏™‡∏î‡∏∏' : resourceType; // More descriptive name
                showMessageBox(`‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î ${facility.name}! ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ${cost[resourceType]} ${missingResourceName}`);
            }
        }

        // Assign survivor to facility slot
        function assignSurvivorToFacility(survivorId, facilityId) {
            const survivor = gameData.survivors.find(s => s.id === survivorId);
            const facility = gameData.shelter[facilityId];

            if (!survivor || !facility) return;
            if (survivor.isBusy || survivor.isInjured) {
                showMessageBox(`${survivor.name} ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà!`);
                return;
            }
            if (survivor.assignedFacilityId) {
                 showMessageBox(`${survivor.name} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô ${gameData.shelter[survivor.assignedFacilityId].name} ‡πÅ‡∏•‡πâ‡∏ß!`);
                 return;
            }
            if (facility.assignedSurvivors.length >= facility.slots) {
                showMessageBox(`${facility.name} ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß!`);
                return;
            }
            if (facility.level === 0 || facility.isUpgrading) {
                showMessageBox(`${facility.name} ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏≠‡∏¢‡∏π‡πà!`);
                return;
            }


            survivor.assignedFacilityId = facilityId;
            facility.assignedSurvivors.push(survivorId);
            survivor.isBusy = true; // Mark as busy when assigned to facility
            addLog(`${survivor.name} ‡∏ñ‡∏π‡∏Å‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô ${facility.name} ‡πÅ‡∏•‡πâ‡∏ß`);
            updateUI();
        }

        // Unassign survivor from facility slot
        function unassignSurvivorFromFacility(survivorId, facilityId) {
            const survivor = gameData.survivors.find(s => s.id === survivorId);
            const facility = gameData.shelter[facilityId];

            if (!survivor || !facility) return;

            facility.assignedSurvivors = facility.assignedSurvivors.filter(id => id !== survivorId);
            survivor.assignedFacilityId = null;
            survivor.isBusy = false; // No longer busy
            addLog(`${survivor.name} ‡∏ñ‡∏π‡∏Å‡∏ñ‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ${facility.name} ‡πÅ‡∏•‡πâ‡∏ß`);
            updateUI();
        }

        // --- UI Update Functions ---
        function updateUI() {
            currentDayEl.textContent = gameData.currentDay;
            playerScrapEl.textContent = gameData.scrap;
            playerFoodEl.textContent = gameData.food;
            playerWaterEl.textContent = gameData.water;
            playerMedSuppliesEl.textContent = gameData.medSupplies;

            renderSurvivors();
            renderScavengeMissions();
            renderSelectedSurvivorDetails();
            renderInventory();
            renderShelterFacilities();
            updateSendScavengeMissionButtonState();
            updateBuyItemButtonState();

            viewToggleButton.innerHTML = gameData.currentView === 'outpost'
                ? '<span class="mr-2">&#x1F3E0;</span> ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏û‡∏¥‡∏á'
                : '<span class="mr-2">&#x1F3D8;</span> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Outpost';
        }

        function renderSurvivors() {
            survivorListEl.innerHTML = '';
            const unassignedSurvivors = gameData.survivors.filter(s => s.assignedFacilityId === null);

            if (unassignedSurvivors.length === 0) {
                survivorListEl.innerHTML = '<div class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</div>';
                return;
            }

            unassignedSurvivors.forEach(survivor => {
                const itemDiv = document.createElement('div');
                let statusText = '';
                let statusColor = 'text-blue-300';

                if (survivor.isBusy) {
                    statusText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏Ç‡∏≠‡∏á (${survivor.missionEndTime - gameData.currentDay} ‡∏ß‡∏±‡∏ô)`;
                } else if (survivor.isInjured) {
                    statusText = `‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö (${survivor.injuryDuration} ‡∏ß‡∏±‡∏ô)`;
                    statusColor = 'text-red-400';
                }

                itemDiv.className = `list-item ${survivor.id === gameData.selectedSurvivorId ? 'selected' : ''} ${survivor.isBusy || survivor.isInjured ? 'list-item-disabled' : ''}`;
                itemDiv.dataset.survivorId = survivor.id;
                itemDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-lg">${survivor.name}</p>
                        <p class="text-sm text-gray-300">‡πÄ‡∏•‡πÄ‡∏ß‡∏•: ${survivor.level} | XP: ${survivor.xp}/${XP_TO_LEVEL[survivor.level] || 'MAX'}</p>
                    </div>
                    ${statusText ? `<span class="text-sm ${statusColor}">${statusText}</span>` : ''}
                `;
                itemDiv.addEventListener('click', () => {
                    if (survivor.isBusy || survivor.isInjured) return;
                    gameData.selectedSurvivorId = survivor.id;
                    gameData.selectedItemId = null;
                    updateUI();
                });
                survivorListEl.appendChild(itemDiv);
            });
        }

        function renderScavengeMissions() {
            scavengeMissionListEl.innerHTML = '';
            if (gameData.scavengeMissions.length === 0) {
                scavengeMissionListEl.innerHTML = '<div class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>';
                return;
            }

            gameData.scavengeMissions.forEach(mission => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `list-item ${mission.id === gameData.selectedMissionId ? 'selected' : ''}`;
                itemDiv.dataset.missionId = mission.id;

                let difficultyColor = 'text-green-300';
                if (mission.difficulty === '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á') difficultyColor = 'text-yellow-300';
                if (mission.difficulty === '‡∏¢‡∏≤‡∏Å') difficultyColor = 'text-red-300';

                const displayedDuration = getEffectiveMissionDuration(mission.duration);

                itemDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-lg">${mission.name}</p>
                        <p class="text-sm text-gray-300">
                            ‡∏£‡∏∞‡∏î‡∏±‡∏ö: <span class="${difficultyColor}">${mission.difficulty}</span> |
                            ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${mission.scrapReward}<span class="text-gray-400">&#x1F529;</span>, ${mission.xpReward} XP
                            ${mission.itemReward ? `, ${ALL_ITEMS[mission.itemReward].name}` : ''}<br>
                            ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ${displayedDuration} ‡∏ß‡∏±‡∏ô ${displayedDuration < mission.duration ? `(<span class="text-green-400">‡∏•‡∏î‡∏•‡∏á ${mission.duration - displayedDuration} ‡∏ß‡∏±‡∏ô</span>)` : ''}
                        </p>
                    </div>
                `;
                itemDiv.addEventListener('click', () => {
                    gameData.selectedMissionId = mission.id;
                    updateUI();
                });
                scavengeMissionListEl.appendChild(itemDiv);
            });
        }

        function renderSelectedSurvivorDetails() {
            const survivor = gameData.survivors.find(s => s.id === gameData.selectedSurvivorId);
            if (survivor) {
                selectedSurvivorDetailsEl.classList.remove('hidden');
                detailsPanelEl.querySelector('p').classList.add('hidden');

                const effectiveStats = calculateSurvivorStats(survivor);

                detailSurvivorNameEl.textContent = survivor.name;
                detailSurvivorLevelEl.textContent = survivor.level;
                detailSurvivorXpEl.textContent = survivor.xp;
                detailSurvivorXpNeededEl.textContent = XP_TO_LEVEL[survivor.level] || 'MAX';
                detailSurvivorHealthEl.textContent = survivor.health;
                detailSurvivorMaxHealthEl.textContent = survivor.maxHealth;
                detailSurvivorInjuredStatusEl.textContent = survivor.isInjured ? `(‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö ${survivor.injuryDuration} ‡∏ß‡∏±‡∏ô)` : '';
                detailSurvivorStrengthEl.textContent = effectiveStats.strength;
                detailSurvivorAgilityEl.textContent = effectiveStats.agility;

                equippedItemsDisplayEl.innerHTML = ``;
                const slots = [
                    { name: '‡∏´‡∏°‡∏ß‡∏Å', id: 'helmet', icon: '&#x1F3A9;' },
                    { name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠', id: 'chest', icon: '&#x1F455;' },
                    { name: '‡πÅ‡∏Ç‡∏ô', id: 'arms', icon: '&#x1F9E4;' },
                    { name: '‡∏Ç‡∏≤', id: 'legs', icon: '&#x1F456;' },
                    { name: '‡∏°‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å', id: 'mainHand', icon: '&#x1F5E1;&#xFE0F;' },
                    { name: '‡∏°‡∏∑‡∏≠‡∏£‡∏≠‡∏á', id: 'offHand', icon: '&#x1F6E1;&#xFE0F;' }
                ];

                slots.forEach(slot => {
                    const equippedItemId = survivor.equipped[slot.id];
                    const equippedItemName = equippedItemId ? ALL_ITEMS[equippedItemId].name : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'equipped-slot';
                    slotDiv.innerHTML = `
                        <span class="equipped-slot-name">${slot.icon} ${slot.name}:</span>
                        <div>
                            <span class="equipped-item-name">${equippedItemName}</span>
                            ${equippedItemId ? `<button class="unequip-button" data-slot="${slot.id}" data-survivor-id="${survivor.id}">‡∏ñ‡∏≠‡∏î‡∏≠‡∏≠‡∏Å</button>` : ''}
                        </div>
                    `;
                    equippedItemsDisplayEl.appendChild(slotDiv);
                });

                equippedItemsDisplayEl.querySelectorAll('.unequip-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const slot = event.target.dataset.slot;
                        const survivorId = event.target.dataset.survivorId;
                        unequipItem(survivorId, slot);
                    });
                });

                healSurvivorButton.disabled = (!survivor.isInjured && survivor.health === survivor.maxHealth) || gameData.medSupplies < HEAL_COST_MED_SUPPLIES;

            } else {
                selectedSurvivorDetailsEl.classList.add('hidden');
                detailsPanelEl.querySelector('p').classList.remove('hidden');
            }
        }

        function renderInventory() {
            inventoryListEl.innerHTML = '';
            let hasItems = false;
            for (const itemId in ALL_ITEMS) {
                const item = ALL_ITEMS[itemId];
                const quantity = gameData.inventory[itemId] || 0;

                // Show all non-consumable items and all owned consumables
                if (item.type !== 'consumable' || quantity > 0) {
                    hasItems = true;

                    const itemDiv = document.createElement('div');
                    itemDiv.className = `list-item text-sm ${itemId === gameData.selectedItemId ? 'selected' : ''}`;
                    itemDiv.dataset.itemId = itemId;

                    let bonusText = '';
                    if (item.bonus) {
                        const bonuses = [];
                        if (item.bonus.strength) bonuses.push(`STR+${item.bonus.strength}`);
                        if (item.bonus.agility) bonuses.push(`AGI+${item.bonus.agility}`);
                        bonusText = `(${bonuses.join(', ')})`;
                    }

                    const displayCost = getBuyCost(itemId);

                    const qtyDisplay = quantity > 0 ? ` x${quantity}` : '';

                    let buttonHtml = '';
                    if (gameData.selectedSurvivorId && item.type !== 'consumable' && item.slot !== 'none') {
                        buttonHtml = `<button class="button button-secondary text-sm px-3 py-1 ml-2" data-action="equip" data-item-id="${itemId}" ${quantity === 0 ? 'disabled' : ''}>‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà</button>`;
                    }
                    else if (item.type !== 'consumable') {
                        buttonHtml = `<button class="button button-secondary text-sm px-3 py-1 ml-2" data-action="select-buy" data-item-id="${itemId}">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠</button>`;
                    }


                    itemDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.icon} ${item.name}${qtyDisplay}</p> <!-- Added item.icon -->
                            <p class="text-gray-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${item.type === 'weapon' ? '‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò' : item.type === 'armor' ? '‡∏ä‡∏∏‡∏î‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô' : '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏¥‡πâ‡∏á'} ${bonusText}</p>
                            <p class="text-gray-400">‡∏£‡∏≤‡∏Ñ‡∏≤: ${displayCost.scrap}<span class="text-gray-400">&#x1F529;</span></p>
                        </div>
                        ${buttonHtml}
                    `;
                    itemDiv.addEventListener('click', (event) => {
                        if (event.target.tagName === 'BUTTON') {
                            const action = event.target.dataset.action;
                            const clickedItemId = event.target.dataset.itemId;
                            if (action === 'equip' && gameData.selectedSurvivorId) {
                                equipItem(gameData.selectedSurvivorId, clickedItemId);
                            } else if (action === 'select-buy') {
                                gameData.selectedItemId = clickedItemId;
                                updateUI();
                            }
                        } else {
                            gameData.selectedItemId = itemId;
                            updateUI();
                        }
                    });
                    inventoryListEl.appendChild(itemDiv);
                }
            }

            if (!hasItems) {
                inventoryListEl.innerHTML = '<div class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</div>';
            }
        }


        function renderShelterFacilities() {
            shelterFacilitiesListEl.innerHTML = '';
            const availableSurvivors = gameData.survivors.filter(s => s.assignedFacilityId === null && !s.isBusy && !s.isInjured);

            for (const facilityId in gameData.shelter) {
                const facility = gameData.shelter[facilityId];
                const upgradeCost = getUpgradeCost(facilityId);
                const upgradeDuration = getUpgradeDuration(facilityId);
                const resourceType = Object.keys(upgradeCost)[0];

                const canUpgrade = gameData[resourceType] >= upgradeCost[resourceType] && facility.level < facility.maxLevel && !facility.isUpgrading;
                const isMaxLevel = facility.level >= facility.maxLevel;
                const isActive = facility.level > 0 && !facility.isUpgrading;

                let statusText = '';
                if (facility.level === 0) statusText = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á (Lv. ${facility.level})`;
                else if (facility.isUpgrading) statusText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î... (${facility.upgradeEndTime - gameData.currentDay} ‡∏ß‡∏±‡∏ô)`;
                else statusText = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Lv. ${facility.level})`;


                let assignedSurvivorsHtml = '';
                if (facility.assignedSurvivors.length > 0) {
                    assignedSurvivorsHtml = `<div class="facility-assigned-survivors">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢: `;
                    facility.assignedSurvivors.forEach(survivorId => {
                        const assignedSurvivor = gameData.survivors.find(s => s.id === survivorId);
                        if (assignedSurvivor) {
                            assignedSurvivorsHtml += `<span>${assignedSurvivor.name} <button class="unequip-button" data-survivor-id="${survivorId}" data-facility-id="${facilityId}">‡∏ñ‡∏≠‡∏ô‡∏ï‡∏±‡∏ß</button></span>`;
                        }
                    });
                    assignedSurvivorsHtml += `</div>`;
                }

                const assignButtonEnabled = isActive && facility.assignedSurvivors.length < facility.slots && availableSurvivors.length > 0;
                const assignButtonHtml = assignButtonEnabled ?
                    `<select class="bg-gray-700 text-white p-1 rounded mr-2" id="assign-select-${facilityId}">
                        ${availableSurvivors.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                    </select>
                    <button class="button button-secondary text-sm px-3 py-1" data-action="assign" data-facility-id="${facilityId}">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</button>`
                    : `<span class="text-sm text-gray-500">${isActive ? (facility.assignedSurvivors.length === facility.slots ? '‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ß‡πà‡∏≤‡∏á') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢'}</span>`;


                const itemDiv = document.createElement('div');
                itemDiv.className = `list-item flex-col items-start`;
                itemDiv.innerHTML = `
                    <div class="w-full flex justify-between items-center mb-2">
                        <p class="font-semibold text-lg">${facility.name} <span class="text-gray-400 text-base">(${statusText})</span></p>
                        ${!isMaxLevel && !facility.isUpgrading ?
                            `<button class="button button-secondary text-sm px-3 py-1" data-action="upgrade" data-facility-id="${facilityId}" ${!canUpgrade ? 'disabled' : ''}>
                                ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (${upgradeCost[resourceType]}<span class="text-gray-400">&#x1F529;</span>, ${upgradeDuration} ‡∏ß‡∏±‡∏ô)
                            </button>` :
                            (isMaxLevel ? `<span class="text-sm text-gray-400">‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>` : '')
                        }
                    </div>
                    <p class="text-sm text-gray-300 w-full mb-2">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå: ${facility.benefitDesc}</p>
                    ${isActive ? `<p class="text-sm text-gray-300">‡∏ä‡πà‡∏≠‡∏á: ${facility.assignedSurvivors.length}/${facility.slots}</p>` : ''}
                    ${assignedSurvivorsHtml}
                    ${isActive && !facility.isUpgrading ? `<div class="w-full flex items-center justify-end mt-2">${assignButtonHtml}</div>` : ''}
                `;
                shelterFacilitiesListEl.appendChild(itemDiv);

                // Attach event listener for upgrade button
                const upgradeButton = itemDiv.querySelector('button[data-action="upgrade"]');
                if (upgradeButton) {
                    upgradeButton.addEventListener('click', (event) => {
                        const id = event.target.dataset.facilityId;
                        upgradeFacility(id);
                    });
                }

                // Attach event listener for assign button
                const assignButton = itemDiv.querySelector('button[data-action="assign"]');
                if (assignButton) {
                    assignButton.addEventListener('click', (event) => {
                        const id = event.target.dataset.facilityId;
                        const selectEl = document.getElementById(`assign-select-${id}`);
                        if (selectEl && selectEl.value) {
                            assignSurvivorToFacility(selectEl.value, id);
                        }
                    });
                }

                // Attach event listener for unassign buttons
                itemDiv.querySelectorAll('.unequip-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const survivorId = event.target.dataset.survivorId;
                        const facilityId = event.target.dataset.facilityId;
                        unassignSurvivorFromFacility(survivorId, facilityId);
                    });
                });
            }
        }

        function updateSendScavengeMissionButtonState() {
            const survivor = gameData.survivors.find(s => s.id === gameData.selectedSurvivorId);
            const mission = gameData.scavengeMissions.find(m => m.id === gameData.selectedMissionId);

            if (survivor && mission && !survivor.isBusy && !survivor.isInjured && survivor.assignedFacilityId === null) {
                sendScavengeMissionButton.disabled = false;
            } else {
                sendScavengeMissionButton.disabled = true;
            }
        }

        function updateBuyItemButtonState() {
            const selectedItem = gameData.selectedItemId ? ALL_ITEMS[gameData.selectedItemId] : null;
            if (selectedItem) {
                const cost = getBuyCost(selectedItem.id);
                buyItemButton.disabled = (gameData.scrap < cost.scrap || gameData.food < cost.food || gameData.water < cost.water || gameData.medSupplies < cost.medSupplies);

                let costText = `${cost.scrap}<span class="text-gray-400">&#x1F529;</span>`;
                if (cost.food > 0) costText += `, ${cost.food}<span class="text-green-400">&#x1F355;</span>`;
                if (cost.water > 0) costText += `, ${cost.water}<span class="text-blue-400">&#x1F4A7;</span>`;
                if (cost.medSupplies > 0) costText += `, ${cost.medSupplies}<span class="text-red-400">&#x1F48A;</span>`;
                itemBuyCostEl.innerHTML = costText;
            } else {
                buyItemButton.disabled = true;
                itemBuyCostEl.textContent = '0';
            }
        }

        // --- Event Listeners ---
        nextDayButton.addEventListener('click', () => {
            gameData.currentDay++;
            addLog(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${gameData.currentDay}`);

            // Daily resource consumption
            gameData.food = Math.max(0, gameData.food - gameData.survivors.length * 5);
            gameData.water = Math.max(0, gameData.water - gameData.survivors.length * 5);
            addLog(`‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏ä‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥ ${gameData.survivors.length * 5} ‡∏´‡∏ô‡πà‡∏ß‡∏¢`);
            if (gameData.food === 0 || gameData.water === 0) {
                 addLog(`‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏¥‡∏ß‡πÇ‡∏´‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏´‡∏≤‡∏¢‡∏ô‡πâ‡∏≥!`);
                 // Implement negative effects for starvation/dehydration here
            }

            // Daily resource production from facilities and facility upgrade completion
            for (const facilityId in gameData.shelter) {
                const facility = gameData.shelter[facilityId];

                // Complete upgrades
                if (facility.isUpgrading && facility.upgradeEndTime <= gameData.currentDay) {
                    facility.isUpgrading = false;
                    facility.level++;
                    facility.slots = facility.level; // Update slots based on new level
                    addLog(`${facility.name} ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡πÄ‡∏ß‡∏• ${facility.level} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß!`);
                }

                // Production from active facilities (not upgrading)
                if (facility.level > 0 && !facility.isUpgrading) {
                    if (facility.production) {
                        for (const resType in facility.production) {
                            let produced = facility.level * facility.production[resType];
                            // Add bonus from assigned survivors (e.g., 5% per survivor)
                            if (facility.assignedSurvivors.length > 0) {
                                produced += produced * facility.assignedSurvivors.length * 0.05; // 5% bonus per assigned survivor
                            }
                            produced = Math.round(produced); // Round to nearest whole number
                            gameData[resType] += produced;
                            addLog(`${facility.name} ‡∏ú‡∏•‡∏¥‡∏ï ${resType === 'food' ? '‡∏≠‡∏≤‡∏´‡∏≤‡∏£' : resType === 'water' ? '‡∏ô‡πâ‡∏≥' : '‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå'} ‡πÑ‡∏î‡πâ ${produced} ‡∏´‡∏ô‡πà‡∏ß‡∏¢`);
                        }
                    }
                }
            }


            // Process survivor states (injury, mission completion)
            for (let i = gameData.survivors.length - 1; i >= 0; i--) {
                const survivor = gameData.survivors[i];

                // Reduce injury duration
                if (survivor.isInjured && survivor.injuryDuration > 0) {
                    survivor.injuryDuration--;
                    if (survivor.injuryDuration === 0) {
                        survivor.isInjured = false;
                        addLog(`${survivor.name} ‡∏´‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß!`);
                    }
                }

                // Process completed missions (only if not assigned to facility)
                if (survivor.isBusy && survivor.currentMissionId && survivor.missionEndTime <= gameData.currentDay) {
                    processMissionResults(survivor); // This function might remove the survivor
                }
            }

            if (gameData.currentDay % 3 === 0) {
                generateNewScavengeMissions();
            }

            updateUI();
        });

        saveGameButton.addEventListener('click', saveGame);
        loadGameButton.addEventListener('click', loadGame);
        viewToggleButton.addEventListener('click', toggleView);

        sendScavengeMissionButton.addEventListener('click', sendSurvivorOnScavengeMission);
        buyItemButton.addEventListener('click', buyItem);
        messageBoxOk.addEventListener('click', () => hideMessageBox(true)); // For confirm box 'ok'
        messageBoxCancel.addEventListener('click', () => hideMessageBox(false)); // For confirm box 'cancel'

        healSurvivorButton.addEventListener('click', () => {
            if (gameData.selectedSurvivorId) {
                healSurvivor(gameData.selectedSurvivorId);
            }
        });


        // --- Initial Load ---
        window.onload = initializeGame;
    </script>
</body>
</html>
